name: ì†¡ì´ë²„ì„¯ ê²½ë§¤ ë°ì´í„° ìˆ˜ì§‘

on:
  schedule:
    # ì†¡ì´ ê²½ë§¤ ì‹œê°„: ì˜¤ì „ 10ì‹œ~ì˜¤í›„ 10ì‹œ (KST), 9-11ì›”ë§Œ
    # GitHub ActionsëŠ” UTC ê¸°ì¤€ì´ë¯€ë¡œ KST -9ì‹œê°„
    # KST 10:00-22:00 = UTC 01:00-13:00
    - cron: "0 1-13 * 9-11 *" # 9-11ì›”, ë§¤ì¼ UTC 01:00-13:00 (KST 10:00-22:00)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  collect-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: Playwright ë¸Œë¼ìš°ì € ìºì‹œ í™•ì¸
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: Playwright ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npx playwright install-deps chromium

      - name: ê²½ë§¤ ë°ì´í„° ìˆ˜ì§‘
        env:
          DAYS_TO_CHECK: 5 # ìµœê·¼ 5ì¼ë§Œ í™•ì¸
        run: npx playwright test tests/generateRawData.spec.ts

      - name: í†µê³„ ìƒì„±
        run: npm run generate-stats

      - name: Git ì„¤ì •
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        run: |
          echo "=== ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ==="
          git status --porcelain
          echo "=== ëª¨ë“  ìƒì„± íŒŒì¼ ì¶”ê°€ ==="
          git add public/auction-data/ public/auction-stats/ || true
          echo "=== Git ìƒíƒœ ì¬í™•ì¸ ==="
          git status
          if [ -n "$(git status --porcelain)" ]; then
            echo "ìƒˆë¡œìš´ ê²½ë§¤ ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤."
            git commit -m "ğŸ„ ê²½ë§¤ ë°ì´í„° ìë™ ìˆ˜ì§‘ $(date +'%Y-%m-%d %H:%M KST')"
            git push
          else
            echo "ìˆ˜ì§‘í•  ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ì‹¤í–‰ ê²°ê³¼ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: $(date +'%Y-%m-%d %H:%M KST')"
          echo "=== Git ìƒíƒœ ë””ë²„ê·¸ ==="
          git status
          echo "=== ìƒì„±ëœ íŒŒì¼ í™•ì¸ ==="
          ls -la public/auction-data/ || echo "auction-data í´ë” ì—†ìŒ"
          ls -la public/auction-stats/ || echo "auction-stats í´ë” ì—†ìŒ"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
