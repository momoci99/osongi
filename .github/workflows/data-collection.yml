name: ì†¡ì´ë²„ì„¯ ê²½ë§¤ ë°ì´í„° ìˆ˜ì§‘

on:
  schedule:
    # ë§¤ì‹œê°„ ì •ê°ì— ì‹¤í–‰ (KST ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •)
    - cron: "0 * * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  collect-data:
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: Playwright ë¸Œë¼ìš°ì € ìºì‹œ í™•ì¸
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: Playwright ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npx playwright install-deps chromium

      - name: ê²½ë§¤ ë°ì´í„° ìˆ˜ì§‘
        env:
          DAYS_TO_CHECK: 3 # ìµœê·¼ 3ì¼ë§Œ í™•ì¸
        run: npx playwright test tests/generateRawData.spec.ts

      - name: í†µê³„ ìƒì„±
        run: npm run generate-stats

      - name: Git ì„¤ì •
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        run: |
          git add public/auction-data/
          if [ -n "$(git status --porcelain)" ]; then
            echo "ìƒˆë¡œìš´ ê²½ë§¤ ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤."
            git commit -m "ğŸ„ ê²½ë§¤ ë°ì´í„° ìë™ ìˆ˜ì§‘ $(date +'%Y-%m-%d %H:%M KST')"
            git push
          else
            echo "ìˆ˜ì§‘í•  ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ì‹¤í–‰ ê²°ê³¼ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: $(date +'%Y-%m-%d %H:%M KST')"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
