# 오송이

대한민국 산림조합중앙회에서 제공하는 연도별 송이버섯 공판 현황을 보다 쉽게 확인할 수 있도록 시각화된 자료를 제공합니다.

## 지역 및 조합 목록

```ts
// 지역별 산림조합 목록
강원: ["홍천", "양구", "인제", "고성", "양양", "강릉", "삼척", "의성"],
경북: ["의성", "안동", "청송", "영덕", "포항", "청도", "상주", "문경", "예청", "영주", "봉화", "울진"],
경남: ["거창"]
```

## 📊 자동 데이터 수집

GitHub Actions를 통해 **송이 경매 시간에 맞춰** 자동으로 최신 데이터를 수집합니다:

- 🕐 **실행 주기**: 매시간 (오전 10시 ~ 오후 10시, KST)
- 🗓️ **실행 기간**: 9월 ~ 11월 (송이 시즌)
- 📅 **수집 범위**: 최근 5일 데이터 확인
- 🔄 **스마트 업데이트**: 변경된 데이터만 자동 갱신
- 📝 **자동 커밋**: 새 데이터/업데이트 발견 시 자동으로 Git에 저장

### 수동 데이터 수집

로컬에서 데이터를 수집하려면:

```bash
# 최근 7일 데이터 수집
npx playwright test tests/generateRawData.spec.ts

# 특정 기간 수집 (환경변수 설정)
DAYS_TO_CHECK=30 npx playwright test tests/generateRawData.spec.ts
```

## 📊 데이터 플로우 & 아키텍처

### 1. 데이터 수집 단계

```
산림조합중앙회 웹사이트
       ↓ (Playwright 자동화)
개별 JSON 파일들 (/public/auction-data/YYYY/MM/DD.json)
       ↓ (빌드 시 통합)
통합 데이터셋 (/public/auction-data/complete-dataset.json)
```

### 2. 클라이언트 데이터 로딩 시스템

#### 🚀 성능 최적화 전략

**기존 문제**: 30일 조회 시 30개의 개별 HTTP 요청 (3-5초 소요)
**해결 방법**: IndexedDB 기반 로컬 데이터 웨어하우징

#### 📥 데이터 로딩 플로우

**첫 방문하는 경우:**

1. 앱 시작 → IndexedDB 메타데이터 확인
2. 로컬 데이터 없음 감지
3. 통합 데이터셋 다운로드 (3.71MB)
4. IndexedDB에 저장
5. 메타데이터 생성
6. 앱 사용 준비 완료

**재방문하는 경우:**

1. 앱 시작 → IndexedDB 메타데이터 확인
2. 로컬 데이터 나이 체크
3. 서버 버전과 비교
4. 필요시에만 업데이트
5. 앱 사용 준비 완료

#### 🗄️ IndexedDB 테이블 구조

```typescript
// 1. auctionData 테이블 (메인 데이터)
- 5,006개 레코드 (2021-2025 송이 시즌 데이터)
- 복합 인덱스: [date+region], [date+union] 등
- 빠른 날짜/지역/조합별 쿼리 지원

// 2. metadata 테이블 (버전 관리)
- 서버 데이터 버전 (ETag/Last-Modified)
- DB 스키마 버전 (자동 마이그레이션)
- 캐시 무효화 정책 (개발: 5분, 프로덕션: 1시간)
```

#### ⚡ 성능 개선 결과

| 시나리오      | 이전 방식    | 새로운 방식 | 개선율      |
| ------------- | ------------ | ----------- | ----------- |
| 7일 조회      | 7 HTTP 요청  | 1 DB 쿼리   | **85% ↓**   |
| 30일 조회     | 30 HTTP 요청 | 1 DB 쿼리   | **96% ↓**   |
| 로딩 시간     | 3-5초        | 50-100ms    | **60배 ⚡** |
| 오프라인 지원 | ❌           | ✅          | -           |

### 3. 스마트 캐싱 & 동기화

#### 🔄 버전 관리 시스템

```
로컬 데이터 검증
  ↓
1. DB 스키마 버전 체크 → 불일치시 완전 초기화
2. 데이터 나이 체크 → 오래된 경우 서버 확인
3. 서버 버전 비교 → 차이 발견시 업데이트
```

#### 🌐 서버 버전 체크 (3단계 폴백)

```
1. HEAD 요청 → ETag/Last-Modified 확인 (가장 빠름)
2. Range 요청 → JSON 버전 필드만 추출 (1KB만 다운로드)
3. 전체 다운로드 → 최후의 수단
```

#### 🛡️ 오프라인 지원

- 네트워크 오류 시 로컬 데이터 계속 사용
- 서비스 워커 없이도 완전한 오프라인 경험
- 데이터 무결성 보장 (카운트/날짜 범위 검증)

### 4. 실시간 데이터 업데이트

#### 🤖 자동화된 데이터 파이프라인

```
GitHub Actions (매시간 실행)
  ↓
새 데이터 감지 → 자동 수집 → Git 커밋
  ↓
Vercel 자동 배포 → 새 complete-dataset.json 생성
  ↓
클라이언트 자동 감지 → IndexedDB 업데이트
```

## 데이터 소스

- 산림조합중앙회 송이 공판 현황 : https://m.nfcf.or.kr/forest/user.tdf?a=user.index.IndexApp&c=1005&mc=MOB
